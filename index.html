<!DOCTYPE html>
<html lang="ja">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>unix time</title>
   <style>
      body {
         -webkit-tap-highlight-color: transparent;
         padding: 10px;
         margin: 0;
         background-color: #151617;
         color: #eee;
         font-family: "Noto Sans JP";
         font-size: 14px;
         font-weight: 200;
      }

      ::selection {
         background-color: transparent;
         color: #fd5;
      }

      @font-face {
      font-family: "Noto Sans JP";
      font-style: normal;
      font-weight: 200;
      font-display: swap;
      src:
         local("Noto Sans JP"),
         local("NotoSansJP-Regular"),
      }
   </style>
</head>
<body>
   <div id="offset">Loading...</div>
   <br>
   <div id="time">Loading...</div>
   <div id="UNIXtime">Loading...</div>
   <script>
      let averageOffset;

      const t0 = Date.now();
      Promise.all([
         fetch("https://3fe5a5f690efc790d4764f1c528a4ebb89fa4168.nict.go.jp/cgi-bin/json"),
         fetch("https://67495dde3b39c2991829589f0101ab7a035eecf5.nict.go.jp/cgi-bin/json")
      ])
      .then(responses => {
         const t1 = Date.now();
         return Promise.all(responses.map(response => response.json()))
            .then(data => ({ data, t0, t1 }));
      })
      .then(({ data, t0, t1 }) => {
         const serverUnixTime1 = data[0].st * 1000;
         const serverUnixTime2 = data[1].st * 1000;

         const timeOffset1 = serverUnixTime1 - t1;
         const timeOffset2 = serverUnixTime2 - t1;

         const latency = t1 - t0;
         const latencOneWay = latency / 2;

         console.log(
            "fetch往復レイテンシ: " + latency + " ms\n" +
            "fetch片道レイテンシ: " + latencOneWay + " ms\n" +
            "サーバー1との差: " + timeOffset1 + " ms\n" +
            "サーバー2との差: " + timeOffset2 + " ms"
         );

         averageOffset = Math.ceil(latencOneWay + ((timeOffset1 + timeOffset2) / 2));

         const offset = document.getElementById("offset");
         const ms = Math.abs(averageOffset);
         const s = (ms / 1000).toFixed(2);
         let text =  "あなたのデバイスの時刻は "

         if (averageOffset > 0) {
             text += s + "秒 (" + ms + " ms) 遅れています";
         } else if (averageOffset < 0) {
             text += s + "秒 (" + ms + " ms) 進んでいます";
         } else {
             text *= "ずれていません (0秒)";
         }

         offset.textContent = text;
         correctedTime();
      });

      function correctedTime() {
         const syncedUnixTime = Date.now() + averageOffset;
         const syncedDate = new Date(syncedUnixTime);

         const A = syncedDate.getFullYear() + "-" +
                   ("0" + (syncedDate.getMonth() + 1)).slice(-2) + "-" +
                   ("0" + syncedDate.getDate()).slice(-2) + " ";
         const B = ["日", "月", "火", "水", "木", "金", "土"][syncedDate.getDay()];
         const C = " " +
                   ("0" + syncedDate.getHours()).slice(-2) + ":" +
                   ("0" + syncedDate.getMinutes()).slice(-2) + ":" +
                   ("0" + syncedDate.getSeconds()).slice(-2) + "." +
                   ("00" + syncedDate.getMilliseconds()).slice(-3);

         document.getElementById("time").textContent = "修正時刻: " + A + "(" + B + ")" + C;
         document.getElementById("UNIXtime").textContent = "修正UNIX時間: " + syncedUnixTime;

         requestAnimationFrame(correctedTime);
      }
   </script>
</body>
</html>
